# Протокол TCP
Transmission Control Protocol – протокол управления передачей, в отличии от [[Протокол UDP]] сервис TCP предоставляет надежную передачку потока байт(reliable byte stream) и сохранение порядка следования сообщений.

От приложения на TCP приходит поток байт, допустим вы что-то скачиваете, поток разбивается на отдельные части – сегменты. Сегменты передаются отдельно от отправителя к получателю. Получатель собирает сегменты и передает принимающему приложению поток байт

![[../Files/output_AVdTmC.gif]]

Подтверждения и повторной отправки недостаточно для надежной передачи потока байт поскольку подтверждение может не дойти до отправителя и тогда он снова отправит сегмент. Для этого каждый начальный байт сегмент нумеруется.

![[../Files/Webp.net-gifmaker (7).gif]]

Из-за того, что такой сегмент(1024) уже есть, повторный сегмент он игнорирует и опять отправляет подтверждение.

# Варианты подтверждения доставки
## Остановка и ожидание (Wi-Fi, канальный уровень)

![[../Files/Pasted image 20220621095201.png]]

## Скользящее окно (TCP, транспортный уровень)
Подтверждается не каждый сегмент, а несколько следующих друг за другом. Таким образом, можно отправить больше данных не дожидаясь подтверждения.

![[../Files/Pasted image 20220621095904.png]]

**Размер окна** – количество байтов данных, которые могут быть переданы без получения подтверждения

![[../Files/Pasted image 20220621095227.png]]

Существует 2 типа подтверждения:
1. Кумулятивное подтверждение - Подтверждение приема указанного байта данных и всех предыдущих  - используется по умолчанию.
2. Выборочное подтверждение (Selective Acknowledgment, SACK) - подтверждение диапазонов принятых байт, может случиться так, что потеряется 1 байт в середине данных, то есть дошло 0-499 байт и от 501-1000 байт, при кумулятивном подтверждении пришлось бы заново отправлять 500-1000 байт. Для использования этого подтверждения нужно дополнительно поле заголовка TCP



# Соединение
Соединение в TCP дуплексное, т.е. данные могут передаваться в обе стороны. Перед отправкой данных по TCP необходимо установить соединение:
1. Убедиться, что отправитель и получатель хотят передавать данные друг другу
	1. Для этого одно устройство отправлять флаг syn
	2. Другое в ответ, отправляет syn + ack подтверждая
	3. Первое устройство снова подтверждает ack
2. Договориться о нумерации потока байт
3. Договорится о параметрах соединения (максимальный размер сегмента и т.п.)
4. После завершения передачи данных соединение TCP разрывается. Существует 2 типа разрыва
	1. Одновременное - обе стороны разорвали соединение. В таком случае посылается сообщение RST
	2. Одностороннее - одна сторона прекращает передавать данные(когда ей больше нечего передавать), но может принимать, когда другой стороны нечего передавать, он тоже разрывает соединение. В таком случае посылается сообщение FIN

![[../Files/Webp.net-gifmaker (8).gif]]

# Формат заголовка

![[tcpframe.excalidraw]]

1. Порядковый номер - первый байт сегмента
2. Номер подтверждения - для гарантии доставки сообщения - используется следующий ожидаемый байт
3. Длина заголовка - по умолчанию 5, если параметров нет, иначе выставляется исходя из размера параметров, размер параметров кратен 4
4. NS CWR и т.д. - Флаги
	1. ECE (ECN-Echo) – устанавливается получателем при получении сигнала о перегрузке от маршрутизатора
	2. CWR (Congestion Window Reduced) – устанавливается отправителем для подтверждения получения сигнала о перегрузке
	3. NS (ECN-nonce concealment protection) – защита от случайного или злонамеренного изменения флагов ECN
5. Размер окна - окно управления потоком - используется для избегания затопления - когда данных поступает слишком много 
6. Параметры 
	1. Максимальный размер сегмента (Maximum Segment Size, MSS)
	2. Масштаб окна - позволяет увеличить размер окна до 1 ГБ, что эффективно для быстрых каналов
	3. Выборочное подтверждение (Selective Acknowledgment, SACK) – подтверждение диапазонов принятых байт
	4. Метки времени

# Затопление и перегрузка
Для решения вопроса с затоплением используется окно управления потоком. В формате заголовка в размере окна указывается размер сегментов который клиент может принять.

![[../Files/Webp.net-gifmaker (9).gif]] Zero window probe - запрос того, что размер окна все еще равен 0. 

Для разрешения перегрузки используется окно управления перегрузкой - предотвращение отправки в сеть большого количества сегментов, которые перегрузят сеть - окна перегрузки определяет сколько сегментов можно отправить в сеть, т.е. все зависит не только от того, сколько сегментов может принять устройство, но и от циркуляции сегментов по сети. Существует 3 типа сигнала о перегрузке:
1. Потеря сегмента
2. Задержка сегмента - отправитель замеряет среднее время отправки, при увеличении размер окна уменьшается
3. Сигнал от [[Маршрутизатор]] Random Early Detection и Explicit Congestion Notification
